<?php


/**
 * implements hook_webform_submission_update()
 *
 * @param $node
 * @param $submission
 */
function halle96_webform_webform_submission_update($node, $submission) {
  dpm($node);
  dpm($submission);
}

/**
 * Implements hook_menu().
 */
function halle96_webform_menu() {
  $items['admin/structure/ticket_notifications'] = [
    'title' => 'Ticket Notifications',
    'description' => 'Set the notifications for ticket status changes.',
    'page callback' => 'drupal_get_form',
    'page arguments' => ['form_ticket_notifications'],
    'access arguments' => ['administer ticket notifications'],
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  ];
  return $items;
}

/**
 * Implements hook_permission().
 */
function halle96_webform_permission() {
  return ['administer ticket notifications' => [
    'title' => t('Administer ticket notifications')
    ]
  ];
}

/**
 * The form function for the configuration of ticket mails.
 *
 * @param $form
 * @param $form_state
 *
 * @return mixed
 */
function form_ticket_notifications($form, &$form_state) {
  $default_values_mail_author = variable_get(halle96_webform_mail_author);
  $default_values_mail_admin = variable_get(halle96_webform_mail_admin);

  $form['description'] = [
    '#type' => 'item',
    '#title' => t('Administer notifications for ticket status changes'),
  ];
  $form['mail_author'] = [
    '#tree' => TRUE,
    '#type' => 'fieldset',
    '#title' => t('Email to ticket author'),
  ];
  $form['mail_author']['subject'] = [
    '#type' => 'textfield',
    '#title' => t('Subject'),
    '#default_value' => $default_values_mail_author['subject']
  ];
  $form['mail_author']['text'] = [
    '#type' => 'textarea',
    '#title' => t('Text'),
    '#default_value' => $default_values_mail_author['text']
  ];
  $form['mail_admin'] = [
    '#tree' => TRUE,
    '#type' => 'fieldset',
    '#title' => t('Email to admins')
  ];
  $form['mail_admin']['recipients'] = [
    '#type' => 'textfield',
    '#title' => t('Mail addresses of recipients'),
    '#description' => t('Enter comma separated mail addresses'),
    '#default_value' => $default_values_mail_admin['recipients']
  ];
  $form['mail_admin']['subject'] = [
    '#type' => 'textfield',
    '#title' => t('Subject'),
    '#default_value' => $default_values_mail_admin['subject']
  ];
  $form['mail_admin']['text'] = [
    '#type' => 'textarea',
    '#title' => t('Text'),
    '#default_value' => $default_values_mail_admin['text']
  ];
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );

  return $form;
}

function form_ticket_notifications_submit($form, &$form_state) {
  variable_set('halle96_webform_mail_author', $form_state['values']['mail_author']);
  variable_set('halle96_webform_mail_admin', $form_state['values']['mail_admin']);
  drupal_set_message(
    t('The options for ticket notifications were saved.'
    )
  );
}


